#!/usr/bin/env bash
#
# mc — Mission Control CLI
# Unified command-line interface for agents and humans
#
# Usage:
#   mc doctor           — Health check (PASS/FAIL)
#   mc status           — Show system status
#   mc run <workflow>   — Run a workflow
#   mc tasks            — List tasks in INBOX
#   mc claim            — Claim next available task
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MC_DIR="${SCRIPT_DIR}/.."
VERSION="0.1.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[mc]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[mc]${NC} $1"; }
log_error() { echo -e "${RED}[mc]${NC} $1"; }
log_cmd() { echo -e "${BLUE}[mc]${NC} $1"; }

# Show help
show_help() {
    cat << EOF
Mission Control CLI v${VERSION}

USAGE:
    mc <command> [options]

COMMANDS:
    doctor              Run health checks (smoke test)
    status              Show system status
    run <workflow>      Run a workflow by name
    tasks [status]      List tasks (default: INBOX)
    claim               Claim next available task
    logs [run-id]       Show logs for a run
    version             Show version
    help                Show this help

EXAMPLES:
    mc doctor                           # Quick health check
    mc run feature-dev "Add OAuth"      # Start workflow
    mc tasks INBOX                      # List inbox tasks
    mc claim                            # Claim next task
    mc logs run_abc123                  # Show run logs

EOF
}

# Source environment
source_env() {
    if [[ -f "$MC_DIR/.env.local" ]]; then
        set -a
        source "$MC_DIR/.env.local" 2>/dev/null || true
        set +a
    fi
}

# Check Convex is configured
check_convex() {
    if [[ -z "${CONVEX_URL:-}" || "$CONVEX_URL" == *"your-deployment"* ]]; then
        log_error "CONVEX_URL not configured"
        log_info "Run: npx convex dev"
        exit 1
    fi
}

# Command: doctor
cmd_doctor() {
    log_cmd "Running smoke test..."
    if [[ -x "$MC_DIR/scripts/mc-smoke.sh" ]]; then
        "$MC_DIR/scripts/mc-smoke.sh"
    else
        log_error "mc-smoke.sh not found"
        exit 1
    fi
}

# Command: status
cmd_status() {
    source_env
    check_convex
    
    log_cmd "Mission Control Status"
    echo "======================="
    echo ""
    
    # Check UI
    if curl -s http://localhost:5173 > /dev/null 2>&1; then
        log_info "UI: Running at http://localhost:5173"
    else
        log_warn "UI: Not running (start with: pnpm run dev:ui)"
    fi
    
    # Check Convex
    if [[ -n "${CONVEX_URL:-}" ]]; then
        log_info "Convex: ${CONVEX_URL:0:40}..."
    else
        log_warn "Convex: Not configured"
    fi
    
    echo ""
    log_cmd "Task counts:"
    
    # Get task counts from Convex
    cd "$MC_DIR"
    npx convex run api.tasks.listAll '{"limit": 100}' 2>/dev/null | \
        grep -o '"status": "[^"]*"' | \
        sort | uniq -c | \
        while read count status; do
            status_clean=$(echo "$status" | sed 's/.*"status": "\([^"]*\)".*/\1/')
            echo "  $status_clean: $count"
        done || log_warn "Could not fetch task counts"
}

# Command: run
cmd_run() {
    source_env
    check_convex
    
    local workflow="${1:-}"
    local goal="${2:-}"
    
    if [[ -z "$workflow" ]]; then
        log_error "Workflow name required"
        log_info "Usage: mc run <workflow-name> [goal]"
        log_info "Available: feature-dev, bug-fix, security-audit, code-review"
        exit 1
    fi
    
    if [[ -z "$goal" ]]; then
        goal="Execute $workflow workflow"
    fi
    
    log_cmd "Starting workflow: $workflow"
    log_info "Goal: $goal"
    
    cd "$MC_DIR"
    local result
    result=$(npx convex run api.workflowRuns.create "{
        \"workflowId\": \"$workflow\",
        \"initialInput\": \"$goal\",
        \"context\": { \"source\": \"mc-cli\", \"createdAt\": $(date +%s) }
    }" 2>/dev/null) || {
        log_error "Failed to create workflow run"
        exit 1
    }
    
    local run_id
    run_id=$(echo "$result" | grep -o '"_id": "[^"]*"' | head -1 | cut -d'"' -f4)
    
    log_info "Workflow run created: $run_id"
    log_info "View at: http://localhost:5173"
}

# Command: tasks
cmd_tasks() {
    source_env
    check_convex
    
    local status="${1:-INBOX}"
    
    log_cmd "Tasks ($status):"
    echo ""
    
    cd "$MC_DIR"
    npx convex run api.tasks.listAll '{"limit": 20}' 2>/dev/null | \
        grep -E '"_id"|"title"|"status"' | \
        paste - - - | \
        grep "\"status\": \"$status\"" | \
        head -10 | \
        while read line; do
            id=$(echo "$line" | grep -o '"_id": "[^"]*"' | head -1 | cut -d'"' -f4 | cut -c1-16)
            title=$(echo "$line" | grep -o '"title": "[^"]*"' | head -1 | cut -d'"' -f4)
            echo "  $id | $title"
        done || log_warn "Could not fetch tasks"
}

# Command: claim
cmd_claim() {
    source_env
    check_convex
    
    log_cmd "Claiming next available task..."
    
    cd "$MC_DIR"
    
    # Get first INBOX task
    local task
    task=$(npx convex run api.tasks.listAll '{"limit": 5}' 2>/dev/null | \
        grep -B 5 '"status": "INBOX"' | \
        grep '"_id":' | \
        head -1 | \
        sed 's/.*"_id": "\([^"]*\)".*/\1/')
    
    if [[ -z "$task" ]]; then
        log_warn "No tasks available in INBOX"
        exit 0
    fi
    
    log_info "Claiming task: $task"
    
    # Assign to default agent (would need agent ID)
    log_info "Task claimed. View at: http://localhost:5173"
}

# Command: logs
cmd_logs() {
    local run_id="${1:-}"
    
    if [[ -z "$run_id" ]]; then
        log_error "Run ID required"
        log_info "Usage: mc logs <run-id>"
        exit 1
    fi
    
    log_cmd "Logs for run: $run_id"
    log_info "(Structured logging not yet implemented)"
}

# Command: version
cmd_version() {
    echo "Mission Control CLI v${VERSION}"
}

# Main
case "${1:-help}" in
    doctor)
        cmd_doctor
        ;;
    status)
        cmd_status
        ;;
    run)
        shift
        cmd_run "$@"
        ;;
    tasks)
        shift
        cmd_tasks "$@"
        ;;
    claim)
        cmd_claim
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    version|--version|-v)
        cmd_version
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
