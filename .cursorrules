# Mission Control -- Cursor Rules
# This file is read automatically by Cursor at the start of every session.
# It defines the project context, conventions, and constraints that AI must follow.

## Project Identity

Mission Control is a self-hosted orchestration and observability control plane for autonomous AI agent squads. Version 0.9.0. Foundation phase complete; building toward agent runtime and multi-model orchestration.

## Architecture

- **Monorepo:** pnpm workspaces + Turborepo
- **Frontend:** React 18 + TypeScript 5.3 + Vite 5 (apps/mission-control-ui)
- **Backend:** Convex serverless functions (convex/). There is NO Express server. There is NO REST API.
- **Database:** Convex (source of truth: convex/schema.ts, 18 tables)
- **Real-time:** Convex reactive subscriptions via useQuery/useMutation hooks. No WebSocket/SSE code.
- **Background jobs:** Convex cron jobs (convex/crons.ts). No standalone worker processes.
- **Styling:** Tailwind CSS v4 + shadcn/ui components + global CSS (apps/mission-control-ui/src/index.css). Legacy inline styles exist during migration.
- **Package manager:** pnpm 9+
- **Node version:** 18+

## Source of Truth Documents

- PRD and roadmap: docs/PRD_V2.md
- Database schema: convex/schema.ts
- Tech stack versions: docs/TECH_STACK.md
- Design system: docs/FRONTEND_GUIDELINES.md
- User flows: docs/APP_FLOW.md
- Backend API surface: docs/BACKEND_STRUCTURE.md
- Session progress: progress.txt

Read progress.txt at the start of every session to understand what was last worked on.

## Package Map

Existing packages:
- packages/shared -- Shared TypeScript types and utilities (@mission-control/shared)
- packages/state-machine -- Task state validator, 8-state lifecycle (@mission-control/state-machine)
- packages/policy-engine -- Risk classification (GREEN/YELLOW/RED) and approval logic (@mission-control/policy-engine)
- packages/agent-runner -- Proto-runtime: agent registration, heartbeat, task claiming (@mission-control/agent-runner)
- packages/openclaw-sdk -- SDK for external agent integration (@mission-control/openclaw-sdk)
- packages/telegram-bot -- Telegram bot for commands, approvals, notifications (@mission-control/telegram-bot)

Planned (not yet created):
- packages/coordinator -- Central orchestrator (Phase 2)
- packages/agent-runtime -- Full agent lifecycle, evolves agent-runner (Phase 2)
- packages/model-router -- Multi-model abstraction, Claude-only first (Phase 3)
- packages/memory -- Persistent learning system (Phase 2)
- packages/context-router -- Intent detection and routing (Phase 3)

## Task State Machine

8 states: INBOX, ASSIGNED, IN_PROGRESS, REVIEW, NEEDS_APPROVAL, BLOCKED, DONE, CANCELED
- DONE and CANCELED are terminal states
- Transitions enforced by packages/state-machine
- NEEDS_APPROVAL is triggered by budget exceed or RED/YELLOW tool calls
- All transitions require idempotency keys

## Convex Conventions

- Schema defined in convex/schema.ts. Do NOT add tables without updating the schema.
- Queries are read-only. Mutations write data. Actions can call external APIs.
- All public functions use `v.` validators for arguments.
- Most tables have a projectId field for multi-project scoping.
- Use idempotencyKey on creates to prevent duplicates.
- Log important actions to the activities table.
- Cron jobs defined in convex/crons.ts.

## Frontend Conventions

- All components in apps/mission-control-ui/src/
- **Component library:** shadcn/ui (copied into src/components/ui/). Built on Radix UI primitives + Tailwind.
- **Styling:** Tailwind CSS utility classes. Use `cn()` from `@/lib/utils` for conditional classes.
- **Icons:** Lucide React (tree-shakeable, consistent with shadcn).
- **Theming:** CSS variables in index.css for dark/light modes. Tailwind theme reads from CSS vars.
- **Path alias:** `@/` maps to `src/` (configured in tsconfig.json + vite.config.ts).
- Dark theme (default): Enterprise Dark palette via CSS variables.
- Light theme: Available via `[data-theme="light"]` class on root.
- Font: Inter, IBM Plex Sans, system-ui, sans-serif
- Border radius: 0.5rem default (via `--radius` CSS var)
- Animations via framer-motion
- Drag-and-drop via @dnd-kit
- Convex data via useQuery/useMutation hooks
- Legacy inline styles exist in older components; migrate to Tailwind incrementally.

## Coding Standards

- TypeScript strict mode everywhere
- No any types in new code (existing code has some v.any() in schema -- do not add more)
- Prefer named exports over default exports
- Functions over classes for new code
- All Convex functions must validate inputs
- Error messages should be human-readable

## What NOT to Do

- Do NOT create an Express server or REST API (the backend is Convex)
- Do NOT add CSS-in-JS libraries (styled-components, emotion, etc.)
- Do NOT add MUI, Chakra, or other full component libraries (shadcn/ui is the standard)
- Do NOT add new npm dependencies without discussing first
- Do NOT modify convex/schema.ts without updating docs/BACKEND_STRUCTURE.md
- Do NOT hardcode colors -- reference docs/FRONTEND_GUIDELINES.md
- Do NOT skip idempotency keys on Convex mutations that create records
- Do NOT use console.log in production code (use the monitoring/alerts system)
- Do NOT commit .env files

## File Organization

- New UI primitives (shadcn): apps/mission-control-ui/src/components/ui/
- New feature components: apps/mission-control-ui/src/
- Utility functions: apps/mission-control-ui/src/lib/
- New Convex functions: convex/
- New packages: packages/<name>/ with package.json
- Documentation: docs/<category>/
- Agent persona configs (future): agents/*.yaml
- Scripts: scripts/

## Testing (Currently Missing -- Priority for Phase 2)

- No test files exist yet in packages/state-machine or packages/policy-engine
- When writing tests, use vitest
- Test state machine transitions exhaustively
- Test policy engine risk classification for all tool types
